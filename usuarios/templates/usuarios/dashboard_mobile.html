{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Coony</title>
  <link rel="stylesheet" href="{% static 'css/home(mobile).css' %}">
  <!-- Ícones Google -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>

  <!-- Toast Notification System -->
  {% include 'usuarios/components/toast.html' %}

  <!-- Django Messages rendered as Toasts -->
  {% include 'usuarios/components/messages.html' %}

  <!-- Topo -->
  <header class="header">
    <div class="header-icons">
      <span class="material-symbols-outlined">add</span>
      <span class="material-symbols-outlined">chat_bubble</span>
      <span class="material-symbols-outlined">notifications</span>
    </div>
  </header>

  <!-- Saudação -->
  <section class="welcome">
    <h2>Olá, {{ user.nome }}</h2>
    <p>Confira os eventos e atividades próximas</p>
  </section>

  <!-- Busca -->
  <div class="search-container">
    <input type="text" placeholder="Buscar eventos ou atividades...">
    <span class="material-symbols-outlined search-icon">search</span>
  </div>

  <!-- Categorias -->
  <div class="categories">
    <button class="active">Todos</button>
    <button>Corrida</button>
    <button>Ciclismo</button>
    <button>Funcional</button>
  </div>

  {% if eventos %}
    {% for evento in eventos %}
    <div class="event-card">
      <div class="event-img">
        <img src="{% if evento.imagem_capa %}{{ evento.imagem_capa.url }}{% else %}{% static 'img/default-avatar.svg' %}{% endif %}" alt="{{ evento.titulo }}">
        <span class="material-symbols-outlined favorite {% if user and user in evento.favorited_by.all %}favorited{% endif %}" data-event-id="{{ evento.id }}">favorite</span>
      </div>
      <h3>{{ evento.titulo }}</h3>
      <p>{{ evento.descricao|truncatewords:30 }}</p>
      <div class="event-info table-rows">
        <div class="row">
          <div class="cell icon"><span class="material-symbols-outlined">location_on</span></div>
          <div class="cell"><p>{{ evento.local }}</p></div>
        </div>
        <div class="row">
          <div class="cell icon"><span class="material-symbols-outlined">calendar_month</span></div>
          <div class="cell"><p>{{ evento.data|date:'d/m/Y' }} · {{ evento.hora|time:'H\\hi' }}</p></div>
        </div>
      </div>
      <a href="{% url 'evento_detail' evento.id %}" class="btn" style="text-decoration: none; display: inline-block;">Ver detalhes</a>
    </div>
    {% endfor %}
  {% else %}
    <div class="event-card empty-card">
      <h3>Nenhum evento disponível</h3>
      <p>Volte em breve para conferir novos encontros publicados pela comunidade.</p>
    </div>
  {% endif %}

  <script>
  (function() {
    const desktopPath = "{% url 'dashboard' %}";
    const media = window.matchMedia('(max-width: 768px)');

    const ensureDesktop = () => {
      if (window.location.pathname !== desktopPath) {
        window.location.replace(desktopPath);
      }
    };

    if (!media.matches) {
      ensureDesktop();
    }

    const handleChange = (event) => {
      if (!event.matches) {
        ensureDesktop();
      }
    };

    if (typeof media.addEventListener === 'function') {
      media.addEventListener('change', handleChange);
    } else if (typeof media.addListener === 'function') {
      media.addListener(handleChange);
    }
  })();
  </script>

  <script>
  // Favorites toggle (mobile)
  (function(){
    function getCookie(name){
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if(parts.length===2) return parts.pop().split(';').shift();
    }
    const csrftoken = getCookie('csrftoken');
    document.querySelectorAll('.favorite[data-event-id]').forEach(function(el){
      el.addEventListener('click', function(e){
        e.stopPropagation();
        const id = el.getAttribute('data-event-id');
        const base = "{% url 'toggle_favorite_event' 0 %}";
        const url = base.replace('/0/','/' + id + '/');
        console.log('[favorite-mobile] click', id, url);
        const prevState = el.classList.contains('favorited');
        el.classList.toggle('favorited');
        fetch(url, {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrftoken
          },
          credentials: 'same-origin'
        }).then(response => {
          console.log('[favorite-mobile] response', response.status);
          if (!response.ok) {
            if (response.status === 401) alert('Faça login para favoritar eventos.');
            if (prevState) el.classList.add('favorited'); else el.classList.remove('favorited');
            return null;
          }
          return response.json();
        }).then(data => {
          if (!data) return;
          console.log('[favorite-mobile] json', data);
          if (data.favorited) el.classList.add('favorited'); else el.classList.remove('favorited');
        }).catch(err => {
          console.error('Error toggling favorite (mobile)', err);
          if (prevState) el.classList.add('favorited'); else el.classList.remove('favorited');
        });
      });
    });
  })();
  </script>

  <!-- Importa o Navbar Mobile -->
  {% include 'usuarios/components/navbar_mobile.html' %}

</body>
</html>