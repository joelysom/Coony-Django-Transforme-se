{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Coony</title>
  <link rel="stylesheet" href="{% static 'css/home.css' %}">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
</head>
<body>
  
  <!-- Toast Notification System -->
  {% include 'usuarios/components/toast.html' %}
  
  <!-- Django Messages rendered as Toasts -->
  {% include 'usuarios/components/messages.html' %}
  
  <!-- Sidebar como componente externo -->
  {% include 'usuarios/components/sidebar.html' %}

  <!-- Conteúdo principal -->
  <main class="content">

    <!-- Cabeçalho -->
    <section class="welcome">
      <h2>Olá, {{ user.nome }}</h2>
      <p>Confira os eventos e atividades próximas</p>
    </section>

    <!-- Barra de busca -->
    <div class="search-container">
      <input type="text" placeholder="Buscar eventos ou atividades...">
      <span class="material-symbols-outlined search-icon">search</span>
    </div>

    <!-- Categorias -->
    <div class="categories">
      <span class="label">Categorias:</span>
      <button class="active">Todos</button>
      <button>Corrida</button>
      <button>Ciclismo</button>
      <button>Funcional</button>
    </div>

    <!-- Lista de eventos -->
    <div class="events-grid">
      {% if eventos %}
        {% for evento in eventos %}
        <div class="event-card">
          <div class="event-img">
            <img src="{% if evento.imagem_capa %}{{ evento.imagem_capa.url }}{% else %}{% static 'img/default-avatar.svg' %}{% endif %}" alt="{{ evento.titulo }}">
            <span class="material-symbols-outlined favorite {% if user and user in evento.favorited_by.all %}favorited{% endif %}" data-event-id="{{ evento.id }}">favorite</span>
          </div>
          <h3>{{ evento.titulo }}</h3>
          <p>{{ evento.descricao|truncatewords:24 }}</p>
          <div class="event-info">
            <span class="material-symbols-outlined">location_on</span>
            <p>{{ evento.local }}</p>
            <span class="material-symbols-outlined">calendar_month</span>
            <p>{{ evento.data|date:'d/m/Y' }} · {{ evento.hora|time:'H\hi' }}</p>
          </div>
          <button class="btn">Ver detalhes</button>
        </div>
        {% endfor %}
      {% else %}
        <div class="event-card event-card--empty">
          <h3>Nenhum evento disponível.</h3>
          <p>Assim que novos eventos forem publicados, eles aparecerão aqui.</p>
        </div>
      {% endif %}
    </div>
  </main>
  
  <script>
  // Favorites toggle (desktop)
  (function(){
    function getCookie(name){
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if(parts.length===2) return parts.pop().split(';').shift();
    }
    const csrftoken = getCookie('csrftoken');
    document.querySelectorAll('.favorite[data-event-id]').forEach(function(el){
      el.addEventListener('click', function(e){
          e.stopPropagation();
          const id = el.getAttribute('data-event-id');
          const base = "{% url 'toggle_favorite_event' 0 %}";
          const url = base.replace('/0/','/' + id + '/');
          console.log('[favorite] click', id, url);
          // optimistic UI: toggle immediately
          const prevState = el.classList.contains('favorited');
          el.classList.toggle('favorited');
          // send request
          fetch(url, {
            method: 'POST',
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              'X-CSRFToken': csrftoken
            },
            credentials: 'same-origin'
          }).then(response => {
            console.log('[favorite] response status', response.status);
            if (!response.ok) {
              console.warn('Favorite request failed', response.status);
              if (response.status === 401) {
                alert('Faça login para favoritar eventos.');
              }
              // revert optimistic
              if (prevState) el.classList.add('favorited'); else el.classList.remove('favorited');
              return null;
            }
            return response.json();
          }).then(data => {
            if (!data) return;
            console.log('[favorite] response json', data);
            if (data.favorited) el.classList.add('favorited');
            else el.classList.remove('favorited');
          }).catch(err => {
            console.error('Error toggling favorite', err);
            if (prevState) el.classList.add('favorited'); else el.classList.remove('favorited');
          });
        });
    });
  })();

  </script>

  <script>
  (function() {
    const mobilePath = "{% url 'dashboard_mobile' %}";
    const media = window.matchMedia('(max-width: 768px)');

    const ensureMobile = () => {
      if (window.location.pathname !== mobilePath) {
        window.location.replace(mobilePath);
      }
    };

    if (media.matches) {
      ensureMobile();
    }

    const handleChange = (event) => {
      if (event.matches) {
        ensureMobile();
      }
    };

    if (typeof media.addEventListener === 'function') {
      media.addEventListener('change', handleChange);
    } else if (typeof media.addListener === 'function') {
      media.addListener(handleChange);
    }
  })();
  </script>

</body>
</html>
